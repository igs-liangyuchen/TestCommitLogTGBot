name: Git AI Notifier (Gemini Final)

on:
  push:
    branches:
      - main  # å¦‚æœä½ çš„ä¸»åˆ†æ”¯å« masterï¼Œè«‹æ”¹ç‚º master

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: AI Summarize with Gemini
        id: gemini_ai
        env:
          GEMINI_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # 1. å–å¾—æœ€å¾Œä¸€æ¬¡æäº¤çš„è©³ç´°å…§å®¹ (åŒ…å«æäº¤è¨Šæ¯èˆ‡æ›´å‹•çµ±è¨ˆ)
          GIT_LOG=$(git log -1 --pretty=format:"Commit: %s%nAuthor: %an%nDate: %ad")
          GIT_DIFF=$(git diff HEAD^ HEAD --stat)
          PROMPT="ä½ æ˜¯ä¸€ä½é–‹ç™¼ç§˜æ›¸ã€‚è«‹æ ¹æ“šä»¥ä¸‹ Git æäº¤è³‡è¨Šï¼Œç”¨ç¹é«”ä¸­æ–‡å¯«ä¸€ä»½ç°¡çŸ­çš„é–‹ç™¼æ—¥å ±ã€‚
          æäº¤è³‡è¨Šï¼š$GIT_LOG
          æ›´å‹•çµ±è¨ˆï¼š$GIT_DIFF"

          # 2. å‘¼å« Gemini API (ä½¿ç”¨ v1 ç‰ˆæœ¬èˆ‡æœ€æ–°æ¨¡å‹åç¨±)
          # æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨äº† python ä¾†å»ºç«‹ JSON ä»¥é¿å… shell å¼•è™Ÿå ±éŒ¯
          python3 -c "
          import json, os, urllib.request
          api_key = os.getenv('GEMINI_KEY')
          url = f'https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key={api_key}'
          data = {
              'contents': [{'parts': [{'text': '''$PROMPT'''}]}]
          }
          req = urllib.request.Request(url, data=json.dumps(data).encode('utf-8'), headers={'Content-Type': 'application/json'})
          try:
              with urllib.request.urlopen(req) as response:
                  res = json.loads(response.read().decode())
                  summary = res['candidates'][0]['content']['parts'][0]['text']
                  with open('summary.txt', 'w') as f: f.write(summary)
          except Exception as e:
              with open('summary.txt', 'w') as f: f.write(f'AI è™•ç†å‡ºéŒ¯: {str(e)}')
          "
          
          # 3. è®€å–çµæœä¸¦å­˜å…¥ç’°å¢ƒè®Šæ•¸
          echo "AI_RESULT<<EOF" >> $GITHUB_ENV
          cat summary.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send Telegram Message
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # ä½¿ç”¨ Python é€²è¡Œ URL ç·¨ç¢¼ï¼Œç¢ºä¿ Telegram æ¥æ”¶è¨Šæ¯å®‰å…¨
          python3 - <<EOF > payload.txt
          import urllib.parse, os
          summary = os.getenv('AI_RESULT', 'ç„¡æ‘˜è¦å…§å®¹')
          text = f"ğŸ¤– **AI é–‹ç™¼æ—¥å ±**\n\n{summary}"
          print(urllib.parse.quote(text))
          EOF
          
          ENCODED_TEXT=$(cat payload.txt)
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
            -d "chat_id=$TG_ID" \
            -d "text=$ENCODED_TEXT" \
            -d "parse_mode=Markdown"