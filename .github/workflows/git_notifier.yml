name: Git AI Notifier (Final Stable)

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Run Script
        env:
          GEMINI_KEY: ${{ secrets.GEMINI_API_KEY }}
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python3 -c "
          import json, os, urllib.request, urllib.parse, subprocess, sys, html, time

          def run_task():
              # 1. å–å¾—æäº¤è³‡è¨Š
              try:
                  log = subprocess.check_output(['git', 'log', '-1', '--pretty=format:%s']).decode('utf-8')
              except:
                  log = 'ç„¡æäº¤è¨Šæ¯'

              # 2. æº–å‚™å‘¼å« Gemini API
              api_key = os.getenv('GEMINI_KEY')
              url = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent'
              payload = {'contents': [{'parts': [{'text': f'ä½ æ˜¯ä¸€ä½é–‹ç™¼åŠ©ç†ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡ç¸½çµé€™æ¬¡çš„ Git Commitï¼š{log}'}]}]}
              headers = {'Content-Type': 'application/json', 'x-goog-api-key': api_key}
              
              ai_msg = ''
              # åŠ å…¥é‡è©¦é‚è¼¯ï¼šå˜—è©¦ 3 æ¬¡ï¼Œæ¯æ¬¡é–“éš” 5 ç§’
              for i in range(3):
                  try:
                      print(f'>>> æ­£åœ¨å˜—è©¦å‘¼å« AI (ç¬¬ {i+1} æ¬¡)...')
                      req = urllib.request.Request(url, data=json.dumps(payload).encode(), headers=headers)
                      with urllib.request.urlopen(req) as response:
                          res = json.loads(response.read().decode())
                          ai_msg = res['candidates'][0]['content']['parts'][0]['text']
                          print('AI ç”ŸæˆæˆåŠŸï¼')
                          break 
                  except Exception as e:
                      error_detail = e.read().decode() if hasattr(e, 'read') else str(e)
                      if '503' in error_detail or '429' in error_detail:
                          if i < 2:
                              print(f'ä¼ºæœå™¨ç¹å¿™ï¼Œ5ç§’å¾Œé‡è©¦...')
                              time.sleep(5)
                              continue
                      ai_msg = f'AI è™•ç†æœ€çµ‚ç•°å¸¸: {error_detail}'

              # 3. ç™¼é€è‡³ Telegram
              tg_token = os.getenv('TG_TOKEN')
              tg_id = os.getenv('TG_ID')
              safe_ai_msg = html.escape(ai_msg)
              final_text = f'<b>ğŸš€ Gemini 3 é–‹ç™¼å ±å‘Š</b>\n\n{safe_ai_msg}'
              
              try:
                  tg_url = f'https://api.telegram.org/bot{tg_token}/sendMessage'
                  tg_params = urllib.parse.urlencode({'chat_id': tg_id, 'text': final_text, 'parse_mode': 'HTML'}).encode()
                  urllib.request.urlopen(tg_url, data=tg_params)
                  print('Success: Telegram notification sent.')
              except Exception as e:
                  print(f'TG å‚³é€å¤±æ•—: {e}')
                  sys.exit(1)

          if __name__ == '__main__':
              run_task()
          "