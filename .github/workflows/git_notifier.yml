name: Git AI Notifier (Gemini Debug)

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: AI Summarize with Gemini
        id: gemini_ai
        run: |
          # å–å¾—æœ€è¿‘ä¸€æ¬¡çš„ git log
          LOG_DATA=$(git log -1 --pretty=format:"%s")
          
          # å‘¼å« API ä¸¦å°‡çµæœå­˜å…¥æª”æ¡ˆï¼Œæ–¹ä¾¿é™¤éŒ¯
          curl -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${{ secrets.GEMINI_API_KEY }}" \
            -H 'Content-Type: application/json' \
            -d "{
              \"contents\": [{
                \"parts\":[{
                  \"text\": \"è«‹ç”¨ç¹é«”ä¸­æ–‡ç¸½çµé€™æ¬¡çš„ Git Commitï¼š$LOG_DATA\"
                }]
              }]
            }" > response.json

          # æª¢æŸ¥å›å‚³å…§å®¹ (Debug ç”¨)
          cat response.json

          # ä½¿ç”¨ Python è§£æï¼Œä¸¦å¢åŠ éŒ¯èª¤è™•ç†
          SUMMARY=$(python3 -c "
import json, sys
try:
    with open('response.json', 'r') as f:
        data = json.load(f)
    if 'candidates' in data:
        print(data['candidates'][0]['content']['parts'][0]['text'])
    else:
        print('AI è§£æå¤±æ•—ï¼ŒéŒ¯èª¤è¨Šæ¯ï¼š' + json.dumps(data.get('error', 'æœªçŸ¥éŒ¯èª¤')))
except Exception as e:
    print(f'è…³æœ¬å‡ºéŒ¯: {str(e)}')
")
          echo "AI_SUMMARY=$SUMMARY" >> $GITHUB_ENV

      - name: Send Telegram Message
        run: |
          # è™•ç† URL ç·¨ç¢¼é¿å…ç‰¹æ®Šå­—å…ƒé€ æˆ curl å¤±æ•—
          encoded_text=$(python3 -c "import urllib.parse; print(urllib.parse.quote(\"ğŸ¤– **AI é–‹ç™¼æ—¥å ±**\n\n${{ env.AI_SUMMARY }}\"))")
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=$encoded_text" \
            -d "parse_mode=Markdown"