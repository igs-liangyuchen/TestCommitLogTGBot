name: Git AI Notifier (Gemini Fixed)

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: AI Summarize with Gemini
        id: gemini_ai
        env:
          GEMINI_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # 1. å–å¾—æäº¤è¨Šæ¯
          LOG_DATA=$(git log -1 --pretty=format:"%s")
          
          # 2. å‘¼å« API ä¸¦å°‡çµæœå­˜å…¥æª”æ¡ˆ
          curl -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=$GEMINI_KEY" \
            -H 'Content-Type: application/json' \
            -d "{\"contents\": [{\"parts\":[{\"text\": \"è«‹ç”¨ç¹é«”ä¸­æ–‡ç¸½çµé€™æ¬¡çš„ Git Commit å…§å®¹ï¼š$LOG_DATA\"}]}]}" > response.json

          # 3. ä½¿ç”¨ç¨ç«‹çš„ Python è…³æœ¬è§£æï¼Œé¿å… YAML èªæ³•è¡çª
          python3 - <<EOF > summary.txt
          import json
          try:
              with open('response.json', 'r') as f:
                  data = json.load(f)
              if 'candidates' in data:
                  content = data['candidates'][0]['content']['parts'][0]['text']
                  print(content)
              else:
                  err = data.get('error', {}).get('message', 'æœªçŸ¥éŒ¯èª¤')
                  print(f'AI å ±éŒ¯: {err}')
          except Exception as e:
              print(f'è§£æå‡ºéŒ¯: {str(e)}')
          EOF

          # 4. å°‡çµæœå­˜å…¥ç’°å¢ƒè®Šæ•¸
          echo "AI_RESULT=$(cat summary.txt)" >> $GITHUB_ENV

      - name: Send Telegram Message
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # ä½¿ç”¨ Python é€²è¡Œ URL ç·¨ç¢¼ï¼Œç¢ºä¿ Telegram æ¥æ”¶å­—ä¸²å®‰å…¨
          python3 - <<EOF > payload.txt
          import urllib.parse, os
          text = "ğŸ¤– **AI é–‹ç™¼æ—¥å ±**\n\n" + os.getenv('AI_RESULT', 'ç„¡æ‘˜è¦')
          print(urllib.parse.quote(text))
          EOF
          
          ENCODED_TEXT=$(cat payload.txt)
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
            -d "chat_id=$TG_ID" \
            -d "text=$ENCODED_TEXT" \
            -d "parse_mode=Markdown"