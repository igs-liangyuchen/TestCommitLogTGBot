name: Git AI Code Reviewer (Gemini 3)

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2 # å¿…é ˆè‡³å°‘è¨­ç‚º 2 æ‰èƒ½æ¯”å°å‰ä¸€æ¬¡æäº¤

      - name: Run Deep AI Review
        env:
          GEMINI_KEY: ${{ secrets.GEMINI_API_KEY }}
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python3 -c "
          import json, os, urllib.request, urllib.parse, subprocess, sys, html, time

          def run_task():
              # 1. æŠ“å–æœ¬æ¬¡æ”¹å‹•èˆ‡æ­·å²ç´€éŒ„ (fetch-depth å»ºè­°è¨­å¤§ä¸€é»)
              try:
                  log = subprocess.check_output(['git', 'log', '-1', '--pretty=format:%s']).decode('utf-8')
                  diff = subprocess.check_output(['git', 'diff', 'HEAD^', 'HEAD']).decode('utf-8')[:2000]
                  # æŠ“å–æœ€è¿‘ 5 æ¬¡çš„æ­·å²ç°¡è¿°ï¼Œè®“ AI çŸ¥é“è„ˆçµ¡
                  history = subprocess.check_output(['git', 'log', '-5', '--pretty=format:%h - %s', 'HEAD^']).decode('utf-8')
              except:
                  log, diff, history = 'åˆæ¬¡æäº¤', 'ç„¡å·®ç•°', 'ç„¡æ­·å²ç´€éŒ„'

              # 2. è¨­è¨ˆå½±éŸ¿åŠ›åˆ†æ Prompt
              prompt = f'''ä½ æ˜¯ä¸€ä½è³‡æ·±æ¶æ§‹å¸«ã€‚è«‹åŸ·è¡Œã€æ”¹å‹•å½±éŸ¿åŠ›åˆ†æã€‘ï¼š
              
              ã€æœ¬æ¬¡æäº¤å…§å®¹ã€‘: {log}
              ã€ç¨‹å¼ç¢¼å·®ç•° (Diff)ã€‘:
              {diff}
              
              ã€éå» 5 æ¬¡æ­·å²ç´€éŒ„ã€‘:
              {history}
              
              è«‹ç”¨ç¹é«”ä¸­æ–‡å®Œæˆï¼š
              1. **æ”¹å‹•æ‘˜è¦**ï¼šç°¡è¿°æœ¬æ¬¡ä¿®æ­£ã€‚
              2. **é—œè¯å½±éŸ¿è©•ä¼°**ï¼šæ ¹æ“šæ­·å²ç´€éŒ„èˆ‡æœ¬æ¬¡æ”¹å‹•çš„æª”æ¡ˆï¼Œåˆ¤æ–·æ˜¯å¦æœƒå½±éŸ¿åˆ°å°ˆæ¡ˆçš„å…¶ä»–éƒ¨åˆ†ï¼Ÿï¼ˆä¾‹å¦‚ï¼šæ˜¯å¦é‡è¤‡ä¿®æ”¹äº†åŒä¸€å€‹æ•æ„Ÿæ¨¡çµ„ï¼Ÿï¼‰
              3. **é¢¨éšªç­‰ç´š**ï¼šæ¨™è¨» [ä½/ä¸­/é«˜]ï¼Œè‹¥æœ¬æ¬¡æ”¹å‹•èˆ‡éå»æ”¹å‹•æœ‰é‚è¼¯è¡çªï¼Œè«‹ç‰¹åˆ¥è¨»æ˜ã€‚'''

              # 3. å‘¼å« Gemini 3
              api_key = os.getenv('GEMINI_KEY')
              url = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent'
              payload = {'contents': [{'parts': [{'text': prompt}]}]}
              headers = {'Content-Type': 'application/json', 'x-goog-api-key': api_key}
              
              ai_msg = ''
              for i in range(3):
                  try:
                      req = urllib.request.Request(url, data=json.dumps(payload).encode(), headers=headers)
                      with urllib.request.urlopen(req) as response:
                          res = json.loads(response.read().decode())
                          ai_msg = res['candidates'][0]['content']['parts'][0]['text']
                          break 
                  except Exception as e:
                      if i < 2: time.sleep(5); continue
                      ai_msg = f'AI æ·±åº¦åˆ†æå¤±æ•—: {str(e)}'

              # 4. ç™¼é€è‡³ Telegram
              tg_token = os.getenv('TG_TOKEN')
              tg_id = os.getenv('TG_ID')
              safe_ai_msg = html.escape(ai_msg)
              final_text = f'<b>ğŸ”{log}</b>\n\n{safe_ai_msg}'
              
              try:
                  tg_url = f'https://api.telegram.org/bot{tg_token}/sendMessage'
                  tg_params = urllib.parse.urlencode({'chat_id': tg_id, 'text': final_text, 'parse_mode': 'HTML'}).encode()
                  urllib.request.urlopen(tg_url, data=tg_params)
              except:
                  sys.exit(1)

          if __name__ == '__main__':
              run_task()
          "