name: Git AI Notifier (Gemini)

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get Git Diff
        id: git_info
        run: |
          # å–å¾—æœ€å¾Œä¸€æ¬¡æäº¤çš„æ›´å‹•æ‘˜è¦
          DIFF=$(git log -1 --pretty=format:"æäº¤è€…: %an%næ¨™é¡Œ: %s%nå…§å®¹:%n" && git diff HEAD^ HEAD --stat)
          echo "DIFF_DATA<<EOF" >> $GITHUB_ENV
          echo "$DIFF" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: AI Summarize with Gemini
        id: gemini_ai
        run: |
          # ä½¿ç”¨ API å‘¼å« Gemini
          RESPONSE=$(curl https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${{ secrets.GEMINI_API_KEY }} \
            -H 'Content-Type: application/json' \
            -X POST \
            -d '{
              "contents": [{
                "parts":[{
                  "text": "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„é–‹ç™¼ç§˜æ›¸ã€‚è«‹æ ¹æ“šä»¥ä¸‹ Git æäº¤å…§å®¹ï¼Œç”¨ç¹é«”ä¸­æ–‡æ•´ç†æˆä¸€ä»½ç°¡çŸ­ç²¾éŠçš„é–‹ç™¼æ—¥å ±ï¼ŒåŒ…å«ï¼š1. åšäº†ä»€éº¼ 2. å½±éŸ¿ç¯„åœã€‚å…§å®¹å¦‚ä¸‹ï¼š\n${{ env.DIFF_DATA }}"
                }]
              }]
            }')
          
          # æå–å›å‚³çš„æ–‡å­—å…§å®¹ (ä½¿ç”¨ python ç°¡å–®è§£æ JSON)
          SUMMARY=$(echo $RESPONSE | python3 -c "import sys, json; print(json.load(sys.stdin)['candidates'][0]['content']['parts'][0]['text'])")
          
          # å­˜å…¥ç’°å¢ƒè®Šæ•¸
          echo "AI_SUMMARY<<EOF" >> $GITHUB_ENV
          echo "$SUMMARY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send Telegram Message
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=ğŸ¤– **AI é–‹ç™¼æ—¥å ±**%0A%0A${{ env.AI_SUMMARY }}" \
            -d "parse_mode=Markdown"