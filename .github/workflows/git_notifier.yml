name: Git AI Code Reviewer (Gemini 3 Fixed)

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 10 # å¢åŠ æ·±åº¦ä»¥è®€å–æ­·å²

      - name: Run Deep AI Review
        env:
          GEMINI_KEY: ${{ secrets.GEMINI_API_KEY }}
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python3 -c "
          import json, os, urllib.request, urllib.parse, subprocess, sys, html, time, base64, re

          def run_task():
              # 1. æŠ“å– Git è³‡è¨Š
              try:
                  log = subprocess.check_output(['git', 'log', '-1', '--pretty=format:%s']).decode('utf-8')
                  diff = subprocess.check_output(['git', 'diff', '-U1', 'HEAD^', 'HEAD']).decode('utf-8')[:2000]
                  history = subprocess.check_output(['git', 'log', '-5', '--pretty=format:%h - %s', 'HEAD^']).decode('utf-8')
              except:
                  log, diff, history = 'åˆæ¬¡æäº¤', 'ç„¡å·®ç•°', 'ç„¡æ­·å²ç´€éŒ„'

              # 2. å»ºç«‹ Prompt (é¿å…åœ¨å­—ä¸²ä¸­ä½¿ç”¨å¯èƒ½å¼•èµ· Shell èª¤åˆ¤çš„ç¬¦è™Ÿ)
              # å°‡å¤§æ‹¬è™Ÿåˆ†é–‹å¯«ï¼Œé¿å… YAML èª¤åˆ¤
              prompt = f'''ä½ æ˜¯ä¸€ä½å°ˆæ¥­ä»£ç¢¼å¯©æŸ¥å“¡ã€‚è«‹åˆ†æä»¥ä¸‹ Git Diff ä¸¦ä»¥ç²¾ç°¡æ ¼å¼è¼¸å‡ºï¼š
              
              æœ¬æ¬¡æäº¤å…§å®¹: {log}
              
              æ­·å²ç´€éŒ„:
              {history}

              è«‹ä¾ç…§ä»¥ä¸‹æ ¼å¼å›å ±ï¼š
              1. **æ ¸å¿ƒæ”¹å‹•**ï¼šæè¿°æœ¬æ¬¡ push çš„ç›®çš„ã€‚
              2. **ğŸ“¦ çµæ§‹è®Šå‹• (UML)**ï¼š
                 è‹¥æœ‰æ–°å¢é¡åˆ¥æˆ–å‡½å¼ï¼Œè«‹ç”¨ mermaid classDiagram èªæ³•æ¨™è¨»åœ¨ ```mermaid ä»£ç¢¼å¡Šä¸­ã€‚
              3. **é‚è¼¯èª¿æ•´**ï¼šé»å‡ºé—œéµè®Šå‹•é»ã€‚
              4. **æ­·å²ç‰½æ¶‰**ï¼šåˆ†ææ˜¯å¦å½±éŸ¿æ—¢æœ‰ç¨‹å¼ç¢¼ã€‚

              Diff å…§å®¹:
              {diff}
              '''

              # 3. å‘¼å« Gemini 3
              api_key = os.getenv('GEMINI_KEY')
              url = '[https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent](https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent)'
              payload = {'contents': [{'parts': [{'text': prompt}]}]}
              headers = {'Content-Type': 'application/json', 'x-goog-api-key': api_key}
              
              ai_msg = ''
              for i in range(3):
                  try:
                      req = urllib.request.Request(url, data=json.dumps(payload).encode(), headers=headers)
                      with urllib.request.urlopen(req) as response:
                          res = json.loads(response.read().decode())
                          ai_msg = res['candidates'][0]['content']['parts'][0]['text']
                          break 
                  except Exception as e:
                      if i < 2: time.sleep(5); continue
                      ai_msg = f'AI åˆ†æå¤±æ•—: {str(e)}'

              # 4. æå– Mermaid åœ–ç‰‡
              image_url = ''
              match = re.search(r'```mermaid\n(.*?)\n```', ai_msg, re.DOTALL)
              if match:
                  try:
                      mermaid_code = match.group(1).strip()
                      # Mermaid.ink ç·¨ç¢¼
                      base64_string = base64.b64encode(mermaid_code.encode('utf-8')).decode('ascii')
                      image_url = f'[https://mermaid.ink/img/](https://mermaid.ink/img/){base64_string}'
                  except:
                      pass

              # 5. ç™¼é€è‡³ Telegram
              tg_token = os.getenv('TG_TOKEN')
              tg_id = os.getenv('TG_ID')
              
              # æ¸…ç† Markdown ä»£ç¢¼å¡Šï¼Œé¿å… HTML è§£æå ±éŒ¯
              clean_msg = html.escape(ai_msg).replace('```', '---')
              final_text = f'<b>ğŸ” {html.escape(log)}</b>\n\n{clean_msg}'
              
              try:
                  if image_url:
                      # ç™¼é€ç…§ç‰‡æ¨¡å¼
                      tg_url = f'https://api.telegram.org/bot{tg_token}/sendPhoto'
                      data = urllib.parse.urlencode({
                          'chat_id': tg_id,
                          'photo': image_url,
                          'caption': final_text[:1024], # Telegram caption é•·åº¦é™åˆ¶
                          'parse_mode': 'HTML'
                      }).encode()
                  else:
                      # ç´”æ–‡å­—æ¨¡å¼
                      tg_url = f'https://api.telegram.org/bot{tg_token}/sendMessage'
                      data = urllib.parse.urlencode({
                          'chat_id': tg_id,
                          'text': final_text,
                          'parse_mode': 'HTML'
                      }).encode()
                  
                  urllib.request.urlopen(tg_url, data=data)
              except Exception as e:
                  print(f'å‚³é€å¤±æ•—: {e}')

          if __name__ == '__main__':
              run_task()
          "