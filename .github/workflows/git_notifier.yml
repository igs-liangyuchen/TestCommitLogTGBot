name: Git AI Notifier (Stable Version)

on:
  push:
    branches:
      - main  # å¦‚æœæ˜¯ master è«‹æ‰‹å‹•ä¿®æ”¹

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: AI and Telegram Notification
        env:
          GEMINI_KEY: ${{ secrets.GEMINI_API_KEY }}
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # ä½¿ç”¨å–®ä¸€ Python è…³æœ¬å®Œæˆæ‰€æœ‰å·¥ä½œï¼Œç©©å®šæ€§æœ€é«˜
          python3 -c "
          import json, os, urllib.request, urllib.parse, subprocess

          # 1. å–å¾— Git è³‡è¨Š
          try:
              log = subprocess.check_output(['git', 'log', '-1', '--pretty=format:%s']).decode('utf-8')
              diff = subprocess.check_output(['git', 'diff', 'HEAD^', 'HEAD', '--stat']).decode('utf-8')
          except:
              log = 'ç„¡æäº¤è¨Šæ¯'
              diff = ''

          # 2. å‘¼å« Gemini API
          api_key = os.getenv('GEMINI_KEY')
          url = f'https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key={api_key}'
          prompt = f'ä½ æ˜¯ä¸€ä½é–‹ç™¼ç§˜æ›¸ã€‚è«‹æ ¹æ“šä»¥ä¸‹ Git æäº¤è³‡è¨Šç”¨ç¹é«”ä¸­æ–‡å¯«ä¸€ä»½ç°¡çŸ­æ—¥å ±ï¼š\næäº¤å…§å®¹ï¼š{log}\næ›´å‹•çµ±è¨ˆï¼š{diff}'
          
          data = {'contents': [{'parts': [{'text': prompt}]}]}
          req = urllib.request.Request(url, data=json.dumps(data).encode(), headers={'Content-Type': 'application/json'})
          
          try:
              with urllib.request.urlopen(req) as response:
                  res = json.loads(response.read().decode())
                  ai_msg = res['candidates'][0]['content']['parts'][0]['text']
          except Exception as e:
              ai_msg = f'AI è™•ç†å¤±æ•—: {str(e)}'

          # 3. ç™¼é€è‡³ Telegram
          tg_token = os.getenv('TG_TOKEN')
          tg_id = os.getenv('TG_ID')
          final_text = f'ğŸ¤– **AI é–‹ç™¼æ—¥å ±**\n\n{ai_msg}'
          encoded_text = urllib.parse.quote(final_text)
          
          tg_url = f'https://api.telegram.org/bot{tg_token}/sendMessage?chat_id={tg_id}&text={encoded_text}&parse_mode=Markdown'
          urllib.request.urlopen(tg_url)
          "